#!/bin/env bash

THIS_SCRIPT_DIR=$(dirname "$0")
REL_BASE_DIR='../../..'

BASE_DIR=$(cd "${THIS_SCRIPT_DIR}/${REL_BASE_DIR}" && pwd)
DEPLOY_DIR=$(cd "${BASE_DIR}/deploy" && pwd)
BIN_DIR=$(cd "${DEPLOY_DIR}/bin" && pwd)
VERSION=$("${BIN_DIR}/get-version")
export BASE_DIR DEPLOY_DIR BIN_DIR VERSION

FLY_CONFIG_FILE="${DEPLOY_DIR}/fly/fly.toml"

cd "${BASE_DIR}" || exit

flyctl apps list | tail -n +2 | grep -P "^${APP_IMAGE_NAME}[\t]+" > /dev/null || \
  flyctl apps create "${APP_IMAGE_NAME}"

DOCKER_BUILDKIT=0 flyctl deploy \
  -c "${FLY_CONFIG_FILE}" \
  --ha=false
